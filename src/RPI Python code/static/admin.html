<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoAG Admin</title>
    <script src="/static/socket.io.min.js"></script>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #020409;
            --bg-accent: #0c1325;
            --panel: rgba(14, 20, 35, 0.85);
            --panel-border: rgba(255, 255, 255, 0.08);
            --panel-shadow: 0 25px 70px rgba(4, 9, 20, 0.55);
            --tile: rgba(255, 255, 255, 0.04);
            --tile-hover: rgba(255, 255, 255, 0.09);
            --tile-live: linear-gradient(135deg, rgba(248, 113, 113, 0.4), rgba(244, 63, 94, 0.2));
            --text: #f8fafc;
            --muted: #aab3cc;
            --accent: #60a5fa;
            --accent-strong: #2563eb;
            --success: #34d399;
            --danger: #fb7185;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            padding: 3rem 1.5rem 4rem;
            display: flex;
            justify-content: center;
            background: radial-gradient(circle at 15% 20%, rgba(96, 165, 250, 0.15), transparent 35%), radial-gradient(circle at 80% 0%, rgba(248, 113, 113, 0.15), transparent 30%), linear-gradient(135deg, var(--bg-accent), var(--bg));
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text);
            transition: background 0.4s ease;
        }

        body.live-match {
            background: radial-gradient(circle at 20% 25%, rgba(251, 113, 133, 0.25), transparent 40%), radial-gradient(circle at 75% -5%, rgba(96, 165, 250, 0.18), transparent 35%), linear-gradient(135deg, #14050b, #050308 65%, #0b1022);
        }

        .admin-app {
            width: min(1200px, 100%);
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
        }

        header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 1rem;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.9rem, 4vw, 2.7rem);
            letter-spacing: 0.02em;
        }

        .subline {
            margin: 0.4rem 0 0;
            color: var(--muted);
        }

        .status-pill {
            padding: 0.65rem 1.15rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.85rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .status-pill::before {
            content: "";
            width: 0.65rem;
            height: 0.65rem;
            border-radius: 50%;
            background: var(--muted);
        }

        .status-pill.active {
            color: var(--text);
            border-color: rgba(96, 165, 250, 0.4);
        }

        .status-pill.active::before {
            background: var(--success);
            box-shadow: 0 0 12px rgba(52, 211, 153, 0.6);
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 28px;
            padding: 2rem;
            box-shadow: var(--panel-shadow);
            backdrop-filter: blur(18px);
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 1.1rem;
        }

        .tile {
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 1.4rem;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 0.5rem;
            background: var(--tile);
            cursor: pointer;
            transition: transform 0.25s ease, border 0.25s ease, background 0.25s ease;
        }

        .tile::after {
            content: "";
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 0.25s ease;
            background: radial-gradient(circle at top, rgba(96, 165, 250, 0.35), transparent 55%);
        }

        .tile:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 255, 255, 0.25);
            background: var(--tile-hover);
        }

        .tile:hover::after {
            opacity: 1;
        }

        .tile.live {
            background: var(--tile-live);
            border-color: rgba(248, 113, 113, 0.6);
            box-shadow: 0 18px 35px rgba(248, 113, 113, 0.35);
        }

        .tile-id {
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .tile-name {
            font-size: 1.35rem;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .tile-sub {
            font-size: 0.95rem;
            color: var(--muted);
        }

        .list-card h2 {
            margin: 0 0 1rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.95rem;
            color: var(--muted);
        }

        .tally-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .tally-pill {
            padding: 0.6rem 1.1rem;
            border-radius: 999px;
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            letter-spacing: 0.06em;
            font-size: 0.9rem;
            cursor: grab;
            user-select: none;
            transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
        }

        .tally-pill:active {
            cursor: grabbing;
        }

        .tally-pill.dragging {
            opacity: 0.7;
            transform: scale(1.05);
        }

        .tile.drag-over {
            border-color: rgba(96, 165, 250, 0.7);
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
        }

        footer {
            text-align: right;
            color: var(--muted);
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(2, 4, 9, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal--open {
            opacity: 1;
            pointer-events: all;
        }

        .modal__dialog {
            width: min(440px, 100%);
            background: var(--panel);
            border-radius: 28px;
            padding: 2.25rem;
            border: 1px solid rgba(255, 255, 255, 0.12);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            box-shadow: var(--panel-shadow);
        }

        .modal__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .modal__title {
            margin: 0;
            font-size: 1.3rem;
            letter-spacing: 0.04em;
        }

        .modal__close {
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 1.7rem;
            cursor: pointer;
            padding: 0;
        }

        label {
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        input, select {
            width: 100%;
            margin-top: 0.35rem;
            margin-bottom: 0.75rem;
            padding: 0.8rem 0.9rem;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.03);
            color: inherit;
            font-size: 1rem;
        }

        select {
            appearance: none;
            cursor: pointer;
        }

        .modal__actions {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .test-wrapper {
            flex: 1;
        }

        .cooldown {
            position: absolute;
            inset: 2px;
            border-radius: inherit;
            pointer-events: none;
            background: linear-gradient(120deg, rgba(96, 165, 250, 0.35), rgba(37, 99, 235, 0.35));
            border: 1px solid rgba(96, 165, 250, 0.35);
            transform-origin: left;
            transform: scaleX(0);
            opacity: 0;
        }

        button {
            font: inherit;
        }

        .btn {
            padding: 0.85rem 1.1rem;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--accent);
            color: #05182c;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <main class="admin-app">
        <header>
            <div>
                <h1>VideoAG Admin</h1>
                <p class="subline">Steuere Kameranamen &amp; Tally Lights in Echtzeit</p>
            </div>
            <span class="status-pill" id="live-indicator">Live: unbekannt</span>
        </header>

        <section class="panel">
            <div class="camera-grid" id="camera-grid"></div>
        </section>

        <section class="panel list-card">
            <h2>Verfügbare Tally Lights</h2>
            <div class="tally-bank" id="tally-bank">
                <span class="tally-pill">Keine Lichter geladen</span>
            </div>
        </section>

        <footer>© VideoAG Christianeum</footer>
    </main>

    <div class="modal" id="editor-modal" aria-hidden="true">
        <div class="modal__dialog">
            <div class="modal__header">
                <h2 class="modal__title" id="modal-title">Kamera bearbeiten</h2>
                <button class="modal__close" type="button" aria-label="Fenster schließen">&times;</button>
            </div>
            <div>
                <label for="camera-name">Kameraname</label>
                <input id="camera-name" type="text" autocomplete="off" placeholder="Kamera-Namen eingeben">
            </div>
            <div>
                <label for="camera-tally">Tally Light</label>
                <input id="camera-tally" type="text" autocomplete="off" placeholder="z. B. A oder B" maxlength="6">
                <select id="tally-select">
                    <option value="">Aus Liste wählen …</option>
                </select>
            </div>
            <div class="modal__actions">
                <div class="test-wrapper">
                    <button class="btn btn-ghost" type="button" id="test-light" disabled>
                        Tally Light testen
                        <span class="cooldown" id="test-cooldown"></span>
                    </button>
                </div>
                <button class="btn btn-primary" type="button" id="close-editor">Fertig</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const cameraGrid = document.getElementById("camera-grid");
        const tallyBankEl = document.getElementById("tally-bank");
        const modal = document.getElementById("editor-modal");
        const modalTitle = document.getElementById("modal-title");
        const nameInput = document.getElementById("camera-name");
        const tallyInput = document.getElementById("camera-tally");
        const tallySelect = document.getElementById("tally-select");
        const testButton = document.getElementById("test-light");
        const cooldownBar = document.getElementById("test-cooldown");
        const closeButton = document.getElementById("close-editor");
        const modalCloseBtn = document.querySelector(".modal__close");
        const liveIndicator = document.getElementById("live-indicator");

        const CAMERA_COUNT = 8;


        let kamera = 0;
        let editingIndex = null;
        let saveTimeout = null;
        let cooldownTimeout = null;
        let tallyPool = [];
        let camList = [];
        let initialSyncComplete = false;

        
        let cameraData = [];

        function generateCameraData(liste){
            if (!initialSyncComplete){
                console.log("Hier muss die Liste entstehen")
                const createDefaultData = () =>
                Array.from({ length: CAMERA_COUNT }, (_, idx) => ({
                    id: idx + 1,
                    name: liste.cameras[idx + 1].name,
                    tally: liste.cameras[idx + 1].tally
                }));
                return createDefaultData();
            }
            return cameraData;
        }

        const normalizeList = (liste) => {
            if (Array.isArray(liste)) return liste;
            if (typeof liste === "string") {
                try {
                    const parsed = JSON.parse(liste);
                    if (Array.isArray(parsed)) return parsed;
                } catch (error) {
                    return liste.split(/[,;\s]+/).filter(Boolean);
                }
            }
            return [];
        };

        const entryForCamera = (list, id) => {
            if (!Array.isArray(list)) return undefined;
            return list[id] ?? list[id - 1];
        };

        const applyServerData = (liste) => {
            const normalized = normalizeList(liste);
            cameraData = generateCameraData(liste);
            console.log(cameraData)
            cameraData = cameraData.map((camera) => {
                const entry = entryForCamera(normalized, camera.id);
                if (!entry && entry !== "" && entry !== 0) {
                    return camera;
                }
                if (typeof entry === "object") {
                    return {
                        ...camera,
                        name: entry.name || camera.name,
                        tally: entry.tally ?? entry.light ?? entry.value ?? ""
                    };
                }
                return {
                    ...camera,
                    tally: entry === null || entry === undefined ? "" : String(entry)
                };
            });
        };

        const displayTally = (value) => {
            if (!value) return "";
            if (`${value}`.trim() === "0") return "";
            return value;
        };

        const renderGrid = () => {
            cameraGrid.innerHTML = "";
            
            cameraData.forEach((cam, index) => {
                const tile = document.createElement("button");
                tile.type = "button";
                tile.className = `tile${kamera === cam.id ? " live" : ""}`;
                tile.dataset.index = index;
                tile.dataset.cameraId = cam.id;
                tile.innerHTML = `
                    <span class="tile-id">K${cam.id}</span>
                    <div class="tile-name">${cam.name || `Kamera ${cam.id}`}</div>
                    <div class="tile-sub">${displayTally(cam.tally) ? `Tally: ${displayTally(cam.tally)}` : "Kein Tally zugewiesen"}</div>
                `;
                cameraGrid.appendChild(tile);
            });
        };

        const renderTallyBank = () => {
            tallyBankEl.innerHTML = "";
            if (!tallyPool.length) {
                const span = document.createElement("span");
                span.className = "tally-pill";
                span.textContent = "Keine Lichter verfügbar";
                span.style.cursor = "default";
                tallyBankEl.appendChild(span);
                return;
            }

            tallyPool.forEach((tally) => {
                const pill = document.createElement("div");
                pill.className = "tally-pill";
                pill.textContent = tally;
                pill.draggable = true;
                pill.dataset.tally = tally;
                tallyBankEl.appendChild(pill);
            });
        };

        const updateLiveIndicator = () => {
            if (!liveIndicator) return;
            if (kamera) {
                liveIndicator.textContent = `Live: Kamera ${kamera}`;
                liveIndicator.classList.add("active");
            } else {
                liveIndicator.textContent = "Live: keine Kamera";
                liveIndicator.classList.remove("active");
            }
            document.body.classList.toggle("live-match", Boolean(kamera));
        };

        const openEditor = (index) => {
            editingIndex = index;
            const cam = cameraData[index];
            modalTitle.textContent = `Kamera ${cam.id} bearbeiten`;
            nameInput.value = cam.name;
            tallyInput.value = cam.tally;
            populateTallySelect();
            tallySelect.value = tallySelect.querySelector(`option[value="${cam.tally}"]`) ? cam.tally : "";
            updateTestButton();
            modal.classList.add("modal--open");
            nameInput.focus();
        };

        const closeEditor = () => {
            editingIndex = null;
            modal.classList.remove("modal--open");
        };

        const autoSave = () => {
            if (!initialSyncComplete) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                sendeListe();
            }, 250);
        };

        const updateTestButton = () => {
            testButton.disabled = !(tallyInput.value.trim());
        };

        const populateTallySelect = () => {
            tallySelect.innerHTML = `<option value="">Aus Liste wählen …</option>`;
            const unique = [...new Set(tallyPool)].filter(Boolean);
            unique.forEach((tally) => {
                const option = document.createElement("option");
                option.value = tally;
                option.textContent = tally;
                tallySelect.appendChild(option);
            });
        };

        const assignTallyToCamera = (cameraIndex, tally) => {
            const cam = cameraData[cameraIndex];
            if (!cam || !tally) return;
            cam.tally = tally;
            renderGrid();
            renderTallyBank();
            autoSave();
        };

        cameraGrid.addEventListener("click", (event) => {
            const tile = event.target.closest(".tile");
            if (!tile) return;
            const index = Number(tile.dataset.index);
            openEditor(index);
        });

        const handleDragStart = (event) => {
            const pill = event.target.closest(".tally-pill");
            if (!pill || !pill.draggable) return;
            event.dataTransfer.setData("text/plain", pill.dataset.tally);
            pill.classList.add("dragging");
        };

        const handleDragEnd = (event) => {
            const pill = event.target.closest(".tally-pill");
            if (pill) pill.classList.remove("dragging");
        };

        tallyBankEl.addEventListener("dragstart", handleDragStart);
        tallyBankEl.addEventListener("dragend", handleDragEnd);

        cameraGrid.addEventListener("dragover", (event) => {
            event.preventDefault();
            const tile = event.target.closest(".tile");
            if (!tile) return;
            tile.classList.add("drag-over");
        });

        cameraGrid.addEventListener("dragleave", (event) => {
            const tile = event.target.closest(".tile");
            if (!tile) return;
            tile.classList.remove("drag-over");
        });

        cameraGrid.addEventListener("drop", (event) => {
            event.preventDefault();
            const tile = event.target.closest(".tile");
            if (!tile) return;
            tile.classList.remove("drag-over");
            const tally = event.dataTransfer.getData("text/plain");
            const index = Number(tile.dataset.index);
            assignTallyToCamera(index, tally);
        });

        modal.addEventListener("click", (event) => {
            if (event.target === modal) {
                closeEditor();
            }
        });

        modalCloseBtn.addEventListener("click", closeEditor);
        closeButton.addEventListener("click", closeEditor);

        nameInput.addEventListener("input", () => {
            if (editingIndex === null) return;
            const cam = cameraData[editingIndex];
            cam.name = nameInput.value;
            renderGrid();
            autoSave();
        });

        tallyInput.addEventListener("input", () => {
            if (editingIndex === null) return;
            const cam = cameraData[editingIndex];
            cam.tally = tallyInput.value.trim().toUpperCase();
            tallyInput.value = cam.tally;
            if (tallySelect.value !== cam.tally) {
                tallySelect.value = "";
            }
            renderGrid();
            updateTestButton();
            autoSave();
        });

        tallySelect.addEventListener("change", () => {
            if (editingIndex === null) return;
            const value = tallySelect.value;
            const cam = cameraData[editingIndex];
            cam.tally = value;
            tallyInput.value = value;
            renderGrid();
            updateTestButton();
            autoSave();
        });

        testButton.addEventListener("click", () => {
            if (editingIndex === null) return;
            const tally = cameraData[editingIndex].tally;
            if (!tally) return;
            markLight(tally);
            triggerCooldown();
        });

        socket.on("Update", (data) => {
            kamera = Number(data?.Kamera) || 0;
            applyServerData(data?.Liste);
            camList = data?.Liste;
            tallyPool = data?.Pool || tallyPool;
            renderGrid();
            renderTallyBank();
            populateTallySelect();
            updateLiveIndicator();
            initialSyncComplete = true;
        });

        renderGrid();
        renderTallyBank();
        populateTallySelect();
        updateLiveIndicator();
        

        const triggerCooldown = () => {
            clearTimeout(cooldownTimeout);
            testButton.disabled = true;
            cooldownBar.style.transition = "none";
            cooldownBar.style.transform = "scaleX(1)";
            cooldownBar.style.opacity = "1";
            requestAnimationFrame(() => {
                cooldownBar.style.transition = "transform 2s linear, opacity 0.3s ease 1.7s";
                cooldownBar.style.transform = "scaleX(0)";
                cooldownBar.style.opacity = "0";
            });
            cooldownTimeout = setTimeout(() => {
                updateTestButton();
            }, 2000);
        };

        function sendeListe() {
            const payload = Array(CAMERA_COUNT + 1).fill(null);
            cameraData.forEach((cam) => {
                payload[cam.id] = { name: cam.name, tally: cam.tally };
            });
            console.log(initialSyncComplete)
            if (initialSyncComplete){
                socket.emit("admin_command", { cameras: payload, tallyPool });
                console.log("Ich sende jetzt")
            }
        }

        function markLight(light) {
            socket.emit("markLight", light);
        }
    </script>
</body>
</html>
